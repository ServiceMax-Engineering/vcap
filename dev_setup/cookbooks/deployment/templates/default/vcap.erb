#!/bin/bash
#Make sure HOME and USER are set: with monit as a daemon it is not set.
[ -z "$HOME" ] && export HOME=/home/<%= node[:deployment][:user] %>
[ -z "$USER" ] && export USER=<%= node[:deployment][:user] %>
[ -z "$TERM" ] && export TERM=xterm
CLOUD_FOUNDRY_HOME=<%= node[:cloudfoundry][:home] %>
CLOUD_FOUNDRY_VCAP_PATH=<%= node[:cloudfoundry][:path] %>
CLOUD_FOUNDRY_DEPLOYMENT_NAME=<%= node[:deployment][:name] %>

_vcap_log=<%= node[:deployment][:log_path] %>/vcap.log
#don't log status calls:
[ "$1" == "status" ] && _vcap_log=/dev/null
echo `date +%Y-%m-%d-%H%M%S`" vcap called with $@" | tee -a $_vcap_log

# check that the network is correctly setup on this VM: at least one IP that is not the local loop:
ip=`/sbin/ifconfig | grep "inet addr" | grep -v "127.0.0.1" | awk '{ print $2 }' | awk -F: '{ print $2 }'`
if [ -z "$ip" ]; then
  if [ -d "/etc/issue.d/volatile.d" ]; then
    touch /etc/issue.d/volatile.d/K50_applications_status
    echo "Cloudfoundry cannot start: No network is available." > /etc/issue.d/volatile.d/K50_applications_status
  fi
  echo "Cloudfoundry cannot start: No network is available." >> $_vcap_log
  exit 1
fi

# make sure avahi is publishing the aliases if avahi-publishaliases is installed
[ -f /usr/bin/avahi-publish-aliases -a ! -f /tmp/avahi-publish-alias.pid ] && /usr/bin/avahi-publish-aliases

# Make sure the binaries for this vcap runtime are ready:
if [ -z "$CLOUD_FOUNDRY_CONFIG_PATH" ]; then
#  echo "sourcing the cloudfoundry deployment local" | tee -a $_vcap_log
  source $HOME/.cloudfoundry_deployment_local
fi


# reconfigure the urls eventually
if [ "$2" == "dea" -a "$1" != "stop" ]; then
  do_reconfig="true"
elif [ -z "$2" ]; then
  [ "$1" == "restart" ] && do_reconfig="true"
  [ "$1" == "start" ] && do_reconfig="true"
fi
if [ "$do_reconfig" == "true" ]; then

  if [ -d "/etc/issue.d/volatile.d" ]; then
     echo "Starting Cloud Foundry" > /etc/issue.d/volatile.d/K50_applications_status
  fi

  # this is called before the apps are started and after the cloud_controller is started
  # let's make sure that the applications are correctly configured with their url

  # plug your own apps here:
  # call the registration app if there is such a thing it will take care of the dns gateway bind
  if [ -f "/home/ubuntu/intalio/registration_app/start_register_app.rb" ]; then
     cd /home/ubuntu/intalio/registration_app
     [ -z "$RUBYOPT" ] && export RUBYOPT="rubygems"
     ruby start_register_app.rb >> $_vcap_log 2>&1 # | tee -a $_vcap_log # can't redirect
  fi

  cd /home/ubuntu
  echo "calling vmc_knife to make sure the urls are up to date." | tee -a $_vcap_log
  $CLOUD_FOUNDRY_VCAP_PATH/dev_setup/bin/vcap_dev --name $CLOUD_FOUNDRY_DEPLOYMENT_NAME --dir $CLOUD_FOUNDRY_HOME start cloud_controller | tee -a $_vcap_log
  $CLOUD_FOUNDRY_VCAP_PATH/dev_setup/bin/vcap_dev --name $CLOUD_FOUNDRY_DEPLOYMENT_NAME --dir $CLOUD_FOUNDRY_HOME start router | tee -a $_vcap_log
  # wait until cloud_controller is indeed available:
  COUNTER=0
  while [  $COUNTER -lt 20 ]; do
    ready=`wget -SO- -T 1 -t 1 http://api.intalio.priv:9022 2>&1 | grep "200 OK"`
    if [ -n "$ready" ]; then
      COUNTER=40
      [ COUNTER != "0" ] && echo "Cloud Controller is available"
    else
      echo "[ $COUNTER ] Cloud controller is not available yet."
      let COUNTER=COUNTER+1
      sleep 5
    fi
  done
  #vmc_knife login | tee -a $_vcap_log
  vmc_knife configure-applications | tee -a $_vcap_log
  vmc_knife configure-vcap-etc-hosts | tee -a $_vcap_log
  #vmc_knife configure-vcap-mdns | tee -a $_vcap_log
fi

#call vcap with the cmd-line args:
$CLOUD_FOUNDRY_VCAP_PATH/dev_setup/bin/vcap_dev --name $CLOUD_FOUNDRY_DEPLOYMENT_NAME --dir $CLOUD_FOUNDRY_HOME $@ | tee -a $_vcap_log

if [ "$2" == "cloud_controller" ]; then
if [ "$1" == "start" -o "$1" == "restart" ]; then 
  # wait until cloud_controller is indeed available:
  COUNTER=0
  while [  $COUNTER -lt 20 ]; do
    ready=`wget -SO- -T 1 -t 1 http://api.intalio.priv:9022 2>&1 | grep "200 OK"`
    if [ -n "$ready" ]; then
      COUNTER=40
      [ COUNTER != "0" ] && echo "Cloud Controller is available"
    else
      echo "[ $COUNTER ] Cloud controller is not available yet."
      let COUNTER=COUNTER+1
      sleep 5
    fi
  done
fi
fi
